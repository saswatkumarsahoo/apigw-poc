{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "Customers API - Automation PoC",
	"Parameters": {
		"SwaggerBucketName": {
			"Type": "String",
			"Description": "Swagger location inside S3 bucket",
			"Default": "alexa-trial-es"
		},
		"SwaggerPath": {
			"Type": "String",
			"Default": "swagger/Customers-prd-swagger-apigateway.json"
		},
		"SwaggerVersionId": {
			"Type": "String",
			"Description": "Version Id of swagger file",
			"Default": "W6lMQ5R8tTbVjBY.kx_S65OU8MkiPLzq"
		},
		"ApiName": {
			"Type": "String",
			"Description": "Rest API name"
		},
		"StageName": {
			"Type": "String",
			"Description": "Rest API stage name"
		},
		"DeploymentDescription": {
			"Type": "String",
			"Description": "Rest API stage name"
		},
		"S3Bucket" : {
      "Description" : "The name of the bucket that contains custom lambda function",
	  "Default":"alexa-trial-es",
      "Type" : "String"
    },
    "S3Key" : {
      "Description" : "The name of the ZIP package",
      "Type" : "String",
      "Default" : "swagger/amilookup.zip"
    },
	 "ModuleName" : {
      "Description" : "The name of the JavaScript file",
      "Type" : "String",
      "Default" : "amilookup"
    }
	},
	"Resources": {
		"RestApi": {
			"Type": "AWS::ApiGateway::RestApi",
			"Properties": {
				"BodyS3Location": {
					"Bucket": {
						"Ref": "SwaggerBucketName"
					},
					"Version": {
						"Ref": "SwaggerVersionId"
					},
					"Key": {
						"Ref": "SwaggerPath"
					}
				},
				"Name": {
					"Ref": "ApiName"
				},
				"Parameters": {
					"endpointConfigurationTypes": "REGIONAL"
				}
			}
		},
		
	  "Stage": {
	  "DependsOn":["RestApi"]
      "Type": "Custom::Stage",
      "Properties": {
        "ServiceToken": { "Fn::GetAtt" : ["AMIInfoFunction", "Arn"] },
        "Region": { "Ref": "AWS::Region" },
		"ApiId" : { "Ref": "RestApi" },
        "DeploymentDescription":  { "Ref": "DeploymentDescription" },
		"StageName":{ "Ref": "StageName" }
      }
    },
 
    "AMIInfoFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
            "S3Bucket": { "Ref": "S3Bucket" },
            "S3Key": { "Ref": "S3Key" }
        },
        "Handler": { "Fn::Join" : [ "", [{ "Ref": "ModuleName" },".handler"] ] },
        "Role": { "Fn::GetAtt" : ["LambdaExecutionRole", "Arn"] },        
        "Runtime": "nodejs6.10",
        "Timeout": "30"
      }
    },
 
    "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
              "Effect": "Allow",
              "Principal": {"Service": ["lambda.amazonaws.com"]},
              "Action": ["sts:AssumeRole"]
          }]
        },
        "Path": "/",
        "Policies": [{
          "PolicyName": "root",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [{
                "Effect": "Allow",
                "Action": ["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],
                "Resource": "arn:aws:logs:*:*:*"
            },
            {
                "Effect": "Allow",
                "Action": ["apigateway:*"],
                "Resource": "*"
            }]
          }
        }]
      }
    }
}

}